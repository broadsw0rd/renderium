!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Renderium=e()}(this,function(){"use strict";function t(t){throw new Error("\r\nRenderium: "+t)}function e(t){var e=t.getContext("webgl");return e||(e=t.getContext("experimental-webgl")),e}function i(e,i,o){var r=e.createShader(o);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||t("Could not compile shader:\r\n"+e.getShaderInfoLog(r)),r}function o(e,i,o){var r=e.createProgram();return e.attachShader(r,i),e.attachShader(r,o),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)||t("Program failed to link:\r\n"+e.getProgramInfoLog(r)),r}function r(t){return parseInt(t.replace("#",""),16)}function s(t){return t=t.match(/\d+\.?\d*/g),(Number(t[0])<<16)+(Number(t[1])<<8)+Number(t[2])}function n(t){var e;return v[t]?v[t]:("#"===t[0]?e=r(t):"r"===t[0]?e=s(t):utils.throwError("Wrong color format: "+t),w<m&&(v[t]=e,w++),e)}var a=function(t,e,i){if(t+="",(e-=t.length)<=0)return t;if(i||0===i||(i=" ")," "==(i+="")&&e<10)return h[e]+t;for(var o="";1&e&&(o+=i),e>>=1;)i+=i;return o+t},h=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],c={},l={},d=function(){};d.prototype.onload=function(){},d.prototype.getImage=function(t){return l[t]},d.prototype.getStatus=function(t){return c[t]},d.prototype.load=function(t){var e=this,i=this.getStatus(t);if(i!==d.IMAGE_STATUS_LOADING&&i!==d.IMAGE_STATUS_LOADED){c[t]=d.IMAGE_STATUS_LOADING;var o=new window.Image;o.onload=function(){c[t]=d.IMAGE_STATUS_LOADED,l[t]=o,e.onload()},o.src=t}},d.prototype.IMAGE_STATUS_LOADING=d.IMAGE_STATUS_LOADING=1,d.prototype.IMAGE_STATUS_LOADED=d.IMAGE_STATUS_LOADED=2;var p=function(t){void 0===t&&(t={}),this.tasks=t};p.prototype.plan=function(t){this.tasks[t]=!0},p.prototype.complete=function(t){this.tasks[t]=!1},p.prototype.should=function(t){return Boolean(this.tasks[t])};var u=function(){};u.isComponent=function(t){return"function"==typeof t.plot&&"function"==typeof t.draw&&"function"==typeof t.shouldRedraw&&"function"==typeof t.onadd&&"function"==typeof t.onremove},u.prototype.onadd=function(t){},u.prototype.onremove=function(t){},u.prototype.plot=function(t){},u.prototype.draw=function(t){},u.prototype.shouldRedraw=function(){return!0};var f=function t(e){var i=e.Vector,o=e.stats,r=e.width,s=e.height;this.Vector=i||window.Vector,this.width=Number(r)||t.DEFAULT_WIDTH,this.height=Number(s)||t.DEFAULT_HEIGHT,this.logStats=Boolean(o),this.canvas=document.createElement("canvas"),this.imageLoader=new d,this.scheduler=new p({redraw:!1,drawComponents:!1}),this.components=[],this.stats={}};f.prototype.scale=function(e){var i=e.width,o=e.height;this.shouldDrawComponents()&&t("Layer#scale() is forbidden during render cycle"),this.width=Number(i)||f.DEFAULT_WIDTH,this.height=Number(o)||f.DEFAULT_HEIGHT,this.canvas.width=this.width,this.canvas.height=this.height,window.devicePixelRatio&&(this.canvas.width=this.width*f.PIXEL_RATIO,this.canvas.height=this.height*f.PIXEL_RATIO),this.applyStyles(),this.planRedraw()},f.prototype.applyStyles=function(){this.shouldDrawComponents()&&t("Layer#applyStyles() is forbidden during render cycle"),this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.canvas.style.position="absolute",this.canvas.style.top=0,this.canvas.style.left=0,this.canvas.style.right=0,this.canvas.style.bottom=0},f.prototype.clear=function(){this.shouldDrawComponents()&&t("Layer#clear() is forbidden during render cycle"),this.clearStats()},f.prototype.redraw=function(e){var i=this;this.shouldDrawComponents()&&t("Layer#redraw() is forbidden during render cycle"),this.planDrawComponents();for(var o=0;o<this.components.length;o++){var r=i.components[o];(r.shouldRedraw()||i.scheduler.should("redraw"))&&r.plot(i,e),r.draw(i,e)}this.completeDrawComponents(),this.completeRedraw()},f.prototype.forceRedraw=function(){this.planRedraw()},f.prototype.planRedraw=function(){this.scheduler.plan("redraw")},f.prototype.completeRedraw=function(){this.scheduler.complete("redraw")},f.prototype.shouldRedraw=function(){for(var t=this,e=0;e<this.components.length;e++)if(t.components[e].shouldRedraw())return!0;return this.scheduler.should("redraw")},f.prototype.planDrawComponents=function(){this.scheduler.plan("drawComponents")},f.prototype.completeDrawComponents=function(){this.scheduler.complete("drawComponents")},f.prototype.shouldDrawComponents=function(){return this.scheduler.should("drawComponents")},f.prototype.addComponent=function(e){this.shouldDrawComponents()&&t("Layer#addComponent() is forbidden during render cycle"),-1!==this.components.indexOf(e)&&t("Component "+e.constructor.name+" has already been added to layer"),u.isComponent(e)||t("Component "+e.constructor.name+" has not implemented Component interface"),this.components.push(e),this.planRedraw(),e.onadd(this)},f.prototype.addComponents=function(t){t.forEach(this.addComponent,this)},f.prototype.removeComponent=function(e){this.shouldDrawComponents()&&t("Layer#removeComponent() is forbidden during render cycle");var i=this.components.indexOf(e);-1!==i&&(this.components.splice(i,1),this.planRedraw()),e.onremove(this)},f.prototype.removeComponents=function(t){t.forEach(this.removeComponent,this)},f.prototype.clearComponents=function(){this.shouldDrawComponents()&&t("Layer#clearComponents() is forbidden during render cycle"),this.components=[],this.planRedraw()},f.prototype.clearStats=function(){var e=this;this.shouldDrawComponents()&&t("Layer#clearStats() is forbidden during render cycle");for(var i in e.stats)e.stats[i]=0},f.prototype.collectStats=function(t){this.stats[t]++},f.prototype.formatStats=function(){var t=this,e=[];for(var i in t.stats)e.push(i+a(t.stats[i],20-i.length));return e},f.PIXEL_RATIO=window.devicePixelRatio||1,f.DEFAULT_WIDTH=100,f.DEFAULT_HEIGHT=100;var g=function(t,e){var i=t.length;if(i!==e.length)return!1;for(var o=0;o<i;o++)if(t[o]!==e[o])return!1;return!0},y=function(t){function e(e){var i=e.Vector,o=e.stats,r=e.antialiasing,s=e.width,n=e.height;t.call(this,{Vector:i,stats:o,width:s,height:n}),this.antialiasing=Boolean(r),this.ctx=this.canvas.getContext("2d"),this.scale({width:s,height:n}),this.imageLoader.onload=this.planRedraw.bind(this),this.stats={stroke:0,fill:0},this.scheduler.complete("stroke"),this.scheduler.complete("fill")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.scale=function(e){var i=e.width,o=e.height;t.prototype.scale.call(this,{width:i,height:o}),window.devicePixelRatio&&this.ctx.scale(t.PIXEL_RATIO,t.PIXEL_RATIO),this.antialiasing||this.ctx.translate(.5,.5)},e.prototype.clear=function(){t.prototype.clear.call(this),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()},e.prototype.redraw=function(e){t.prototype.redraw.call(this,e),this.performDraw(),this.logStats&&this.drawStats()},e.prototype.stateChanged=function(t){var e=t.color,i=t.fillColor,o=t.width,r=t.lineDash,s=t.opacity;return e&&e!==this.ctx.strokeStyle||i&&i!==this.ctx.fillStyle||o&&o!==this.ctx.lineWidth||s&&s!==this.ctx.globalAlpha||r&&!g(r,this.ctx.getLineDash())},e.prototype.performDraw=function(){this.scheduler.should("stroke")&&(this.ctx.stroke(),this.scheduler.complete("stroke"),this.collectStats("stroke")),this.scheduler.should("fill")&&(this.ctx.fill(),this.scheduler.complete("fill"),this.collectStats("fill")),this.ctx.beginPath()},e.prototype.createGradient=function(t){var e=t.start,i=t.end,o=t.from,r=t.to,s=this.ctx.createLinearGradient(e.x,e.y,i.x,i.y);return s.addColorStop(0,o),s.addColorStop(1,r),s},e.prototype.drawArc=function(t){var e=t.position,i=t.radius,o=t.startAngle,r=t.endAngle,s=t.color,n=t.width;void 0===n&&(n=1);var a=t.opacity;void 0===a&&(a=1);var h=t.lineDash;void 0===h&&(h=[]),this.performDraw(),this.ctx.arc(e.x,e.y,i,o,r),s&&(this.ctx.strokeStyle=s,this.ctx.lineWidth=n,this.ctx.globalAlpha=a,this.ctx.setLineDash(h),this.scheduler.plan("stroke"))},e.prototype.drawCircle=function(t){var e=t.position,i=t.radius,o=t.color,r=t.fillColor,s=t.width;void 0===s&&(s=1);var n=t.opacity;void 0===n&&(n=1);var a=t.lineDash;void 0===a&&(a=[]),this.stateChanged({color:o,fillColor:r,width:s,opacity:n,lineDash:a})&&this.performDraw(),this.drawArc({position:e,radius:i,startAngle:0,endAngle:2*Math.PI,color:o,width:s,opacity:n,lineDash:a}),r&&(this.ctx.fillStyle=r,this.ctx.globalAlpha=n,this.scheduler.plan("fill"))},e.prototype.drawImage=function(t){var e=t.position,i=t.image,o=t.width;void 0===o&&(o=i.width);var r=t.height;void 0===r&&(r=i.height);var s=t.opacity;if(void 0===s&&(s=1),this.performDraw(),"string"==typeof i){if(this.imageLoader.getStatus(i)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(i)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(i):void 0;i=this.imageLoader.getImage(i),o=o||i.width,r=r||i.height}this.ctx.globalAlpha=s,this.antialiasing?this.ctx.drawImage(i,e.x,e.y,o,r):this.ctx.drawImage(i,e.x-.5,e.y-.5,o,r)},e.prototype.drawPolygon=function(t){var e=t.points,i=t.color,o=t.fillColor,r=t.width;void 0===r&&(r=1);var s=t.opacity;void 0===s&&(s=1);var n=t.lineDash;void 0===n&&(n=[]),this.stateChanged({color:i,fillColor:o,width:r,opacity:s,lineDash:n})&&this.performDraw(),this.drawPolyline({points:e.concat(e[0]),color:i,width:r,opacity:s,lineDash:n}),o&&(this.ctx.fillStyle=o,this.ctx.globalAlpha=s,this.scheduler.plan("fill"))},e.prototype.drawPolyline=function(t){var e=this,i=t.points,o=t.color,r=t.width;void 0===r&&(r=1);var s=t.opacity;void 0===s&&(s=1);var n=t.lineDash;void 0===n&&(n=[]),this.stateChanged({color:o,width:r,opacity:s,lineDash:n})&&this.performDraw(),this.ctx.moveTo(i[0].x,i[0].y);for(var a,h=1;h<i.length;h++)a=i[h],e.ctx.lineTo(a.x,a.y);i[0].equals(i[i.length-1])&&this.ctx.closePath(),o&&(this.ctx.strokeStyle=o,this.ctx.lineWidth=r,this.ctx.globalAlpha=s,this.ctx.setLineDash(n),this.scheduler.plan("stroke"))},e.prototype.drawRect=function(t){var e=t.position,i=t.width,o=t.height,r=t.color,s=t.fillColor,n=t.strokeWidth;void 0===n&&(n=1);var a=t.opacity;void 0===a&&(a=1);var h=t.lineDash;void 0===h&&(h=[]),this.stateChanged({color:r,fillColor:s,width:n,opacity:a,lineDash:h})&&this.performDraw(),this.antialiasing?this.ctx.rect(e.x,e.y,i,o):this.ctx.rect(e.x-.5,e.y-.5,i,o),r&&(this.ctx.strokeStyle=r,this.ctx.lineWidth=n,this.ctx.globalAlpha=a,this.ctx.setLineDash(h),this.scheduler.plan("stroke")),s&&(this.ctx.globalAlpha=a,this.ctx.fillStyle=s,this.scheduler.plan("fill"))},e.prototype.drawText=function(t){var e=t.position,i=t.text,o=t.color,r=t.font,s=t.size,n=t.align;void 0===n&&(n="center");var a=t.baseline;void 0===a&&(a="middle");var h=t.opacity;void 0===h&&(h=1),this.performDraw(),this.ctx.fillStyle=o,this.ctx.font=s+"px "+r,this.ctx.textAlign=n,this.ctx.textBaseline=a,this.ctx.globalAlpha=h,this.ctx.fillText(i,e.x,e.y)},e.prototype.measureText=function(t){var e,i=t.text,o=t.font,r=t.size;if(o&&r){var s=this.ctx.font;this.ctx.font=r+"px "+o,e=this.ctx.measureText(i).width,this.ctx.font=s}else e=this.ctx.measureText(i).width;return e},e.prototype.drawStats=function(){for(var t=this,e=this.formatStats(),i=e.length;i--;)t.drawText({position:new t.Vector(t.width-10,t.height-14*(e.length-i)),text:e[i],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},e}(f),v={},w=0,m=64,_="uniform vec2 u_resolution;\r\n\r\nattribute vec2 a_position;\r\nattribute float a_color;\r\n\r\nvarying vec4 v_color;\r\n\r\nconst vec2 unit = vec2(1, -1);\r\n\r\nvec4 convertPoints (vec2 position, vec2 resolution) {\r\n  return vec4((position / resolution * 2.0 - 1.0) * unit, 0, 1);\r\n}\r\n\r\nvec4 convertColor (float color, float alpha) {\r\n  // because bitwise operators not supported\r\n  float b = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  float g = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  float r = mod(color, 256.0) / 255.0;\r\n\r\n  return vec4 (r, g, b, alpha);\r\n}\r\n\r\nvoid main () {\r\n  gl_Position = convertPoints(a_position, u_resolution);\r\n  v_color = convertColor(a_color, 1.0);\r\n}\r\n",E="precision mediump float;\r\n\r\nvarying vec4 v_color;\r\n\r\nvoid main() {\r\n  gl_FragColor = v_color;\r\n}\r\n",A=function(t){function r(r){var s=r.Vector,n=r.stats,a=r.width,h=r.height;t.call(this,{Vector:s,stats:n,width:a,height:h}),this.gl=e(this.canvas),this.scale({width:a,height:h}),this.imageLoader.onload=this.forceRedraw.bind(this),this.vertices=new Float32Array(this.MAX_VERTICES_COUNT),this.indices=new Uint16Array(this.MAX_INDICES_COUNT),this.verticesCount=0,this.indicesCount=0,this._vertexShader=i(this.gl,_,this.gl.VERTEX_SHADER),this._fragmentShader=i(this.gl,E,this.gl.FRAGMENT_SHADER),this._program=o(this.gl,this._vertexShader,this._fragmentShader),this.gl.useProgram(this._program),this._resolutionLocation=this.gl.getUniformLocation(this._program,"u_resolution"),this._positionLocation=this.gl.getAttribLocation(this._program,"a_position"),this._colorLocation=this.gl.getAttribLocation(this._program,"a_color"),this._verticesBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._verticesBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.DYNAMIC_DRAW),this._indicesBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this._positionLocation),this.gl.enableVertexAttribArray(this._colorLocation),this.gl.vertexAttribPointer(this._positionLocation,this.POSITION_SIZE,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*this.ATTRIBUTES_SIZE,0),this.gl.vertexAttribPointer(this._colorLocation,this.COLOR_SIZE,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*this.ATTRIBUTES_SIZE,Float32Array.BYTES_PER_ELEMENT*this.POSITION_SIZE)}t&&(r.__proto__=t),(r.prototype=Object.create(t&&t.prototype)).constructor=r;var s={POSITION_SIZE:{},COLOR_SIZE:{},ATTRIBUTES_SIZE:{},MAX_INDICES_COUNT:{},MAX_VERTICES_COUNT:{}};return s.POSITION_SIZE.get=function(){return 2},s.COLOR_SIZE.get=function(){return 1},s.ATTRIBUTES_SIZE.get=function(){return this.POSITION_SIZE+this.COLOR_SIZE},s.MAX_INDICES_COUNT.get=function(){return 16777215},s.MAX_VERTICES_COUNT.get=function(){return this.MAX_INDICES_COUNT*Math.ceil(this.ATTRIBUTES_SIZE/3)*2},r.prototype.scale=function(e){var i=e.width,o=e.height;t.prototype.scale.call(this,{width:i,height:o}),this.gl.viewport(0,0,this.width*t.PIXEL_RATIO,this.height*t.PIXEL_RATIO)},r.prototype.clear=function(){t.prototype.clear.call(this),this.verticesCount=0,this.indicesCount=0,this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},r.prototype.redraw=function(){t.prototype.redraw.call(this),this.gl.uniform2f(this._resolutionLocation,this.width,this.height),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.vertices.subarray(0,this.verticesCount)),this.gl.bufferSubData(this.gl.ELEMENT_ARRAY_BUFFER,0,this.indices.subarray(0,this.indicesCount)),this.gl.drawElements(this.gl.TRIANGLES,this.indicesCount,this.gl.UNSIGNED_SHORT,0)},r.prototype.createGradient=function(t){var e=t.start,i=t.end,o=t.from,r=t.to;return new Gradient({start:e,end:i,from:o,to:r})},r.prototype.getColor=function(t){return n(t)},r.prototype.drawArc=function(t){},r.prototype.drawCircle=function(t){},r.prototype.drawImage=function(t){var e=t.image;if("string"==typeof e){if(this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(e):void 0;e=this.imageLoader.getImage(e)}},r.prototype.drawPolygon=function(t){var e=t.points,i=t.color,o=t.width;void 0===o&&(o=1),this.collectStats("drawPolygon"),this.drawPolyline({points:e.concat(e[0]),color:i,width:o})},r.prototype.drawPolyline=function(t){this.collectStats("drawPolyline")},r.prototype.drawRect=function(t){var e=t.position,i=t.width,o=t.height,r=t.fillColor;this.collectStats("drawRect");var s=this.verticesCount/this.ATTRIBUTES_SIZE;r=this.getColor(r),this.vertices[this.verticesCount++]=e.x,this.vertices[this.verticesCount++]=e.y,this.vertices[this.verticesCount++]=r,this.vertices[this.verticesCount++]=e.x+i,this.vertices[this.verticesCount++]=e.y,this.vertices[this.verticesCount++]=r,this.vertices[this.verticesCount++]=e.x+i,this.vertices[this.verticesCount++]=e.y+o,this.vertices[this.verticesCount++]=r,this.vertices[this.verticesCount++]=e.x,this.vertices[this.verticesCount++]=e.y+o,this.vertices[this.verticesCount++]=r,this.indices[this.indicesCount++]=s,this.indices[this.indicesCount++]=s+1,this.indices[this.indicesCount++]=s+2,this.indices[this.indicesCount++]=s,this.indices[this.indicesCount++]=s+2,this.indices[this.indicesCount++]=s+3},r.prototype.drawText=function(t){},r.prototype.measureText=function(t){return 0},r.prototype.drawStats=function(){for(var t=this,e=this.formatStats(),i=e.length;i--;)t.drawText({position:new t.Vector(t.width-10,t.height-14*(e.length-i)),text:e[i],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},Object.defineProperties(r.prototype,s),r}(f),S=function(t){var e=t.start,i=t.end,o=t.from,r=t.to;this.start=e,this.end=i,this.from=o,this.to=r,this._isGradient=!0};S.isGradient=function(t){return t&&t._isGradient};var C={RED:"#f44336",PINK:"#e91e63",PURPLE:"#9c27b0",DEEP_PURPLE:"#673ab7",INDIGO:"#3f51b5",BLUE:"#2196f3",LIGHT_BLUE:"#03a9f4",CYAN:"#00bcd4",TEAL:"#009688",GREEN:"#4caf50",LIGHT_GREEN:"#8bc34a",LIME:"#cddc39",YELLOW:"#ffeb3b",AMBER:"#ffc107",ORANGE:"#ff9800",DEEP_ORANGE:"#ff5722",BROWN:"#795548",GREY:"#9e9e9e",BLUE_GREY:"#607d8b"},T=function(t){var e=t.el;this.el=e,this.applyStyles(),this.width=this.el.clientWidth,this.height=this.el.clientHeight,this.layers=[]};return T.spawn=function(e){-1!==T.instances.indexOf(e)&&t("Renderer has already been spawned"),T.instances.push(e)},T.kill=function(t){var e=T.instances.indexOf(t);-1!==e&&T.instances.splice(e,1)},T.digest=function(t){for(var e=0;e<T.instances.length;e++){var i=T.instances[e];i.scale(),i.clear(),i.redraw(t)}},T.prototype.applyStyles=function(){this.el.style.position="relative",this.el.style.width="100%",this.el.style.height="100%"},T.prototype.addLayer=function(e){-1!==this.layers.indexOf(e)&&t("Layer has already been added to renderer"),this.layers.push(e),this.el.appendChild(e.canvas),e.scale({width:this.width,height:this.height})},T.prototype.removeLayer=function(t){var e=this.layers.indexOf(t);-1!==e&&(this.layers.splice(e,1),this.el.removeChild(t.canvas))},T.prototype.scale=function(){var t=this,e=this.el.clientWidth,i=this.el.clientHeight;if(e!==this.width||i!==this.height){for(var o=0;o<this.layers.length;o++)t.layers[o].scale({width:e,height:i});this.width=e,this.height=i}},T.prototype.clear=function(){for(var t=this,e=0;e<this.layers.length;e++){var i=t.layers[e];i.shouldRedraw()&&i.clear()}},T.prototype.redraw=function(t){for(var e=this,i=0;i<this.layers.length;i++){var o=e.layers[i];o.shouldRedraw()&&o.redraw(t)}},T.instances=[],T.BaseLayer=f,T.CanvasLayer=y,T.WebglLayer=A,T.LinearGradient=S,T.Component=u,T.colors=C,T});
