!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Renderium=e()}(this,function(){"use strict";function t(t,e,i){if(t+="",e-=t.length,e<=0)return t;if(i||0===i||(i=" "),i+=""," "===i&&e<10)return c[e]+t;for(var r="";;){if(1&e&&(r+=i),e>>=1,!e)break;i+=i}return r+t}function e(t){throw new Error("\r\nRenderium: "+t)}function i(t){var e=t.getContext("webgl");return e||(e=t.getContext("experimental-webgl")),e}function r(t,i,r){var o=t.createShader(r);t.shaderSource(o,i),t.compileShader(o);var n=t.getShaderParameter(o,t.COMPILE_STATUS);return n||e("could not compile shader:\r\n"+t.getShaderInfoLog(o)),o}function o(t,i,r){var o=t.createProgram();t.attachShader(o,i),t.attachShader(o,r),t.linkProgram(o);var n=t.getProgramParameter(o,t.LINK_STATUS);return n||e("program failed to link:\r\n"+t.getProgramInfoLog(o)),o}function n(t){return parseInt(t.replace("#",""),16)}function s(t){t=t.match(/\d+\.?\d*/g);var e=Number(t[0]),i=Number(t[1]),r=Number(t[2]);return(e<<16)+(i<<8)+r}function a(t){var i;return S[t]?S[t]:("#"===t[0]?i=n(t):"r"===t[0]?i=s(t):e("Wrong color format: "+t),E<A&&(S[t]=i,E++),i)}var h=t,c=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},d=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},f=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},p={},g={},y=function(){function t(){l(this,t)}return t.prototype.onload=function(){},t.prototype.getImage=function(t){return g[t]},t.prototype.getStatus=function(t){return p[t]},t.prototype.load=function(e){var i=this.getStatus(e),r=this;if(i!==t.IMAGE_STATUS_LOADING&&i!==t.IMAGE_STATUS_LOADED){p[e]=t.IMAGE_STATUS_LOADING;var o=new window.Image;o.onload=function(){p[e]=t.IMAGE_STATUS_LOADED,g[e]=this,r.onload()},o.src=e}},t}();y.prototype.IMAGE_STATUS_LOADING=y.IMAGE_STATUS_LOADING=1,y.prototype.IMAGE_STATUS_LOADED=y.IMAGE_STATUS_LOADED=2;var v=Object.freeze({throwError:e}),w=function(){function t(e){var i=e.Vector,r=e.stats,o=e.width,n=e.height;l(this,t),this.Vector=i||window.Vector,this.width=Number(o)||t.DEFAULT_WIDTH,this.height=Number(n)||t.DEFAULT_HEIGHT,this.logStats=Boolean(r),this.canvas=document.createElement("canvas"),this.imageLoader=new y,this.components=[],this.stats={},this._shouldRedraw=!1,this._renderCycleStarted=!1}return t.prototype.scale=function(i){var r=i.width,o=i.height;this._renderCycleStarted&&e("Layer#scale() during render cycle is forbidden"),this.width=Number(r)||t.DEFAULT_WIDTH,this.height=Number(o)||t.DEFAULT_HEIGHT,this.canvas.removeAttribute("width"),this.canvas.removeAttribute("height"),this.canvas.removeAttribute("style"),this.canvas.width=this.width,this.canvas.height=this.height,window.devicePixelRatio&&(this.canvas.width=this.width*t.PIXEL_RATIO,this.canvas.height=this.height*t.PIXEL_RATIO),this.applyStyles(),this.forceRedraw()},t.prototype.applyStyles=function(){this._renderCycleStarted&&e("Layer#applyStyles() during render cycle is forbidden"),this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.canvas.style.position="absolute",this.canvas.style.top=0,this.canvas.style.left=0,this.canvas.style.right=0,this.canvas.style.bottom=0},t.prototype.clear=function(){this._renderCycleStarted&&e("Layer#clear() during render cycle is forbidden"),this.clearStats()},t.prototype.redraw=function(){this._renderCycleStarted&&e("Layer#redraw() during render cycle is forbidden"),this._renderCycleStarted=!0;for(var t=0;t<this.components.length;t++){var i=this.components[t];i.plot(this),i.draw(this)}this._renderCycleStarted=!1,this._shouldRedraw=!1},t.prototype.forceRedraw=function(){this._shouldRedraw=!0},t.prototype.shouldRedraw=function(){for(var t=0;t<this.components.length;t++){var e=this.components[t];if(e.shouldRedraw())return!0}return this._shouldRedraw},t.prototype.addComponent=function(t){this._renderCycleStarted&&e("Layer#addComponent() during render cycle is forbidden");var i=this.components.indexOf(t);i!==-1&&e("Component "+t.constructor.name+" has already been added to layer"),"function"==typeof t.plot&&"function"==typeof t.draw&&"function"==typeof t.shouldRedraw||e("Component "+t.constructor.name+" has not implemented Component interface"),this.components.push(t),this.forceRedraw()},t.prototype.addComponents=function(t){t.forEach(this.addComponent,this)},t.prototype.removeComponent=function(t){this._renderCycleStarted&&e("Layer#removeComponent() during render cycle is forbidden");var i=this.components.indexOf(t);i!==-1&&(this.components.splice(i,1),this.forceRedraw())},t.prototype.removeComponents=function(t){t.forEach(this.removeComponent,this)},t.prototype.clearComponents=function(){this._renderCycleStarted&&e("Layer#clearComponents() during render cycle is forbidden"),this.components=[],this.forceRedraw()},t.prototype.clearStats=function(){this._renderCycleStarted&&e("Layer#clearStats() during render cycle is forbidden");for(var t in this.stats)this.stats[t]=0},t.prototype.collectStats=function(t){this.stats[t]++},t.prototype.formatStats=function(){var t=[],e=20;for(var i in this.stats)t.push(i+h(this.stats[i],e-i.length));return t},t}();w.PIXEL_RATIO=window.devicePixelRatio||1,w.DEFAULT_WIDTH=100,w.DEFAULT_HEIGHT=100;var _=function(){function t(e){var i=e.start,r=e.end,o=e.from,n=e.to;l(this,t),this.start=i,this.end=r,this.from=o,this.to=n,this._isGradient=!0,this._gradient=null}return t.isGradient=function(t){return t&&t._isGradient},t.prototype.createGradient=function(t){return t.collectStats("createGradient"),this._gradient=t.ctx.createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y),this._gradient.addColorStop(0,this.from),this._gradient.addColorStop(1,this.to),this._gradient},t.prototype.valueOf=function(){return this._gradient},t}(),m=function(t){function e(i){var r=i.Vector,o=i.stats,n=i.antialiasing,s=i.width,a=i.height;l(this,e);var h=f(this,t.call(this,{Vector:r,stats:o,width:s,height:a}));return h.antialiasing=Boolean(n),h.ctx=h.canvas.getContext("2d"),h.scale({width:s,height:a}),h.imageLoader.onload=h.forceRedraw.bind(h),h.stats={createGradient:0,drawArc:0,drawCircle:0,drawImage:0,drawPolygon:0,drawPolyline:0,drawRect:0,drawText:0,measureText:0,stroke:0,fill:0},h}return u(e,t),e.prototype.scale=function(e){var i=e.width,r=e.height;t.prototype.scale.call(this,{width:i,height:r}),window.devicePixelRatio&&this.ctx.scale(w.PIXEL_RATIO,w.PIXEL_RATIO),this.antialiasing||this.ctx.translate(.5,.5)},e.prototype.clear=function(){t.prototype.clear.call(this),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()},e.prototype.redraw=function(){t.prototype.redraw.call(this),this.logStats&&this.drawStats()},e.prototype.createGradient=function(t){var e=t.start,i=t.end,r=t.from,o=t.to;return new _({start:e,end:i,from:r,to:o})},e.prototype.getColor=function(t){return _.isGradient(t)?t.createGradient(this):t},e.prototype.drawArc=function(t){var e=t.position,i=t.radius,r=t.startAngle,o=t.endAngle,n=t.color,s=t.width,a=void 0===s?1:s;this.collectStats("drawArc"),this.ctx.strokeStyle=this.getColor(n),this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,r,o),n&&(this.collectStats("stroke"),this.ctx.stroke())},e.prototype.drawCircle=function(t){var e=t.position,i=t.radius,r=t.color,o=t.fillColor,n=t.width,s=void 0===n?1:n;this.collectStats("drawCircle"),this.drawArc({position:e,radius:i,startAngle:0,endAngle:2*Math.PI,color:r,width:s}),o&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(o),this.ctx.fill())},e.prototype.drawImage=function(t){var e=t.position,i=t.image,r=t.width,o=void 0===r?i.width:r,n=t.height,s=void 0===n?i.height:n,a=t.opacity,h=void 0===a?1:a;if(this.collectStats("drawImage"),"string"==typeof i){if(this.imageLoader.getStatus(i)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(i)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(i):void 0;i=this.imageLoader.getImage(i),o=o||i.width,s=s||i.height}var c=this.ctx.globalAlpha;this.ctx.globalAlpha=h,this.antialiasing?this.ctx.drawImage(i,e.x,e.y,o,s):this.ctx.drawImage(i,e.x-.5,e.y-.5,o,s),this.ctx.globalAlpha=c},e.prototype.drawPolygon=function(t){var e=t.points,i=t.color,r=t.fillColor,o=t.width,n=void 0===o?1:o;this.collectStats("drawPolygon"),this.drawPolyline({points:e.concat(e[0]),color:i,width:n}),r&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(r),this.ctx.fill())},e.prototype.drawPolyline=function(t){var e=t.points,i=t.color,r=t.lineDash,o=void 0===r?[]:r,n=t.width,s=void 0===n?1:n;this.collectStats("drawPolyline"),this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(var a,h=1;h<e.length;h++)a=e[h],this.ctx.lineTo(a.x,a.y);this.ctx.setLineDash(o),e[0].equals(e[e.length-1])&&this.ctx.closePath(),i&&(this.collectStats("stroke"),this.ctx.strokeStyle=this.getColor(i),this.ctx.stroke())},e.prototype.drawRect=function(t){var e=t.position,i=t.width,r=t.height,o=t.color,n=t.fillColor,s=t.strokeWidth,a=void 0===s?1:s;this.collectStats("drawRect"),this.ctx.lineWidth=a,this.ctx.beginPath(),this.antialiasing?this.ctx.rect(e.x,e.y,i,r):this.ctx.rect(e.x-.5,e.y-.5,i,r),this.ctx.closePath(),o&&(this.collectStats("stroke"),this.ctx.strokeStyle=this.getColor(o),this.ctx.stroke()),n&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(n),this.ctx.fill())},e.prototype.drawText=function(t){var e=t.position,i=t.text,r=t.color,o=t.font,n=t.size,s=t.align,a=void 0===s?"center":s,h=t.baseline,c=void 0===h?"middle":h;this.collectStats("drawText"),this.ctx.fillStyle=this.getColor(r),this.ctx.font=n+"px "+o,this.ctx.textAlign=a,this.ctx.textBaseline=c,this.ctx.fillText(i,e.x,e.y)},e.prototype.measureText=function(t){var e=t.text,i=t.font,r=t.size;this.collectStats("measureText");var o;if(i&&r){var n=this.ctx.font;this.ctx.font=r+"px "+i,o=this.ctx.measureText(e).width,this.ctx.font=n}else o=this.ctx.measureText(e).width;return o},e.prototype.drawStats=function(){for(var t=this.formatStats(),e=t.length;e--;)this.drawText({position:new this.Vector(this.width-10,this.height-14*(t.length-e)),text:t[e],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},e}(w),S={},E=0,A=64,x=function(){function t(e){var i=e.start,r=e.end,o=e.from,n=e.to;l(this,t),this.start=i,this.end=r,this.from=a(o),this.to=a(n),this._isGradient=!0,this._gradient=null}return t.isGradient=function(t){return t&&t._isGradient},t.prototype.createGradient=function(t){return t.collectStats("createGradient"),this.from},t.prototype.valueOf=function(){return this.from},t}(),T="uniform vec2 u_resolution;\r\n\r\nattribute vec2 a_position;\r\nattribute float a_color;\r\n\r\nvarying vec4 v_color;\r\n\r\nconst vec2 unit = vec2(1, -1);\r\n\r\nvec4 convertPoints (vec2 position, vec2 resolution) {\r\n  return vec4((position / resolution * 2.0 - 1.0) * unit, 0, 1);\r\n}\r\n\r\nvec4 convertColor (float color, float alpha) {\r\n  // because bitwise operators not supported\r\n  float b = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  float g = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  float r = mod(color, 256.0) / 255.0;\r\n\r\n  return vec4 (r, g, b, alpha);\r\n}\r\n\r\nvoid main () {\r\n  gl_Position = convertPoints(a_position, u_resolution);\r\n  v_color = convertColor(a_color, 1.0);\r\n}\r\n",C="precision mediump float;\r\n\r\nvarying vec4 v_color;\r\n\r\nvoid main() {\r\n  gl_FragColor = v_color;\r\n}\r\n",I=function(t){function e(n){var s=n.Vector,a=n.stats,h=n.width,c=n.height;l(this,e);var d=f(this,t.call(this,{Vector:s,stats:a,width:h,height:c}));return d.gl=i(d.canvas),d.scale({width:h,height:c}),d.imageLoader.onload=d.forceRedraw.bind(d),d.vertices=new Float32Array(d.MAX_VERTICES_COUNT),d.indices=new Uint16Array(d.MAX_INDICES_COUNT),d.verticesCount=0,d.indicesCount=0,d._vertexShader=r(d.gl,T,d.gl.VERTEX_SHADER),d._fragmentShader=r(d.gl,C,d.gl.FRAGMENT_SHADER),d._program=o(d.gl,d._vertexShader,d._fragmentShader),d.gl.useProgram(d._program),d._resolutionLocation=d.gl.getUniformLocation(d._program,"u_resolution"),d._positionLocation=d.gl.getAttribLocation(d._program,"a_position"),d._colorLocation=d.gl.getAttribLocation(d._program,"a_color"),d._verticesBuffer=d.gl.createBuffer(),d.gl.bindBuffer(d.gl.ARRAY_BUFFER,d._verticesBuffer),d.gl.bufferData(d.gl.ARRAY_BUFFER,d.vertices,d.gl.DYNAMIC_DRAW),d._indicesBuffer=d.gl.createBuffer(),d.gl.bindBuffer(d.gl.ELEMENT_ARRAY_BUFFER,d._indicesBuffer),d.gl.bufferData(d.gl.ELEMENT_ARRAY_BUFFER,d.indices,d.gl.DYNAMIC_DRAW),d.gl.enableVertexAttribArray(d._positionLocation),d.gl.enableVertexAttribArray(d._colorLocation),d.gl.vertexAttribPointer(d._positionLocation,d.POSITION_SIZE,d.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*d.ATTRIBUTES_SIZE,0),d.gl.vertexAttribPointer(d._colorLocation,d.COLOR_SIZE,d.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*d.ATTRIBUTES_SIZE,Float32Array.BYTES_PER_ELEMENT*d.POSITION_SIZE),d}return u(e,t),e.prototype.scale=function(e){var i=e.width,r=e.height;t.prototype.scale.call(this,{width:i,height:r}),this.gl.viewport(0,0,this.width*w.PIXEL_RATIO,this.height*w.PIXEL_RATIO)},e.prototype.clear=function(){t.prototype.clear.call(this),this.verticesCount=0,this.indicesCount=0,this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},e.prototype.redraw=function(){t.prototype.redraw.call(this),this.gl.uniform2f(this._resolutionLocation,this.width,this.height),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.vertices.subarray(0,this.verticesCount)),this.gl.bufferSubData(this.gl.ELEMENT_ARRAY_BUFFER,0,this.indices.subarray(0,this.indicesCount)),this.gl.drawElements(this.gl.TRIANGLES,this.indicesCount,this.gl.UNSIGNED_SHORT,0)},e.prototype.createGradient=function(t){var e=t.start,i=t.end,r=t.from,o=t.to;return new x({start:e,end:i,from:r,to:o})},e.prototype.getColor=function(t){return x.isGradient(t)?t.createGradient(this):a(t)},e.prototype.drawArc=function(t){t.position,t.radius,t.startAngle,t.endAngle,t.color,t.width},e.prototype.drawCircle=function(t){t.position,t.radius,t.color,t.fillColor,t.width},e.prototype.drawImage=function(t){var e=(t.position,t.image),i=t.width,r=void 0===i?e.width:i,o=t.height,n=void 0===o?e.height:o;t.opacity;if("string"==typeof e){if(this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(e):void 0;e=this.imageLoader.getImage(e),r=r||e.width,n=n||e.height}},e.prototype.drawPolygon=function(t){var e=t.points,i=t.color,r=(t.fillColor,t.width),o=void 0===r?1:r;this.collectStats("drawPolygon"),this.drawPolyline({points:e.concat(e[0]),color:i,width:o})},e.prototype.drawPolyline=function(t){t.points,t.color,t.lineDash,t.width;this.collectStats("drawPolyline")},e.prototype.drawRect=function(t){var e=t.position,i=t.width,r=t.height,o=(t.color,t.fillColor);t.strokeWidth;this.collectStats("drawRect");var n=this.verticesCount/this.ATTRIBUTES_SIZE;o=this.getColor(o),this.vertices[this.verticesCount++]=e.x,this.vertices[this.verticesCount++]=e.y,this.vertices[this.verticesCount++]=o,this.vertices[this.verticesCount++]=e.x+i,this.vertices[this.verticesCount++]=e.y,this.vertices[this.verticesCount++]=o,this.vertices[this.verticesCount++]=e.x+i,this.vertices[this.verticesCount++]=e.y+r,this.vertices[this.verticesCount++]=o,this.vertices[this.verticesCount++]=e.x,this.vertices[this.verticesCount++]=e.y+r,this.vertices[this.verticesCount++]=o,this.indices[this.indicesCount++]=n,this.indices[this.indicesCount++]=n+1,this.indices[this.indicesCount++]=n+2,this.indices[this.indicesCount++]=n,this.indices[this.indicesCount++]=n+2,this.indices[this.indicesCount++]=n+3},e.prototype.drawText=function(t){t.position,t.text,t.color,t.font,t.size,t.align,t.baseline},e.prototype.measureText=function(t){t.text;return 0},e.prototype.drawStats=function(){for(var t=this.formatStats(),e=t.length;e--;)this.drawText({position:new this.Vector(this.width-10,this.height-14*(t.length-e)),text:t[e],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},d(e,[{key:"POSITION_SIZE",get:function(){return 2}},{key:"COLOR_SIZE",get:function(){return 1}},{key:"ATTRIBUTES_SIZE",get:function(){return this.POSITION_SIZE+this.COLOR_SIZE}},{key:"MAX_INDICES_COUNT",get:function(){return 16777215}},{key:"MAX_VERTICES_COUNT",get:function(){return this.MAX_INDICES_COUNT*Math.ceil(this.ATTRIBUTES_SIZE/3)*2}}]),e}(w),L=function(){function t(){l(this,t)}return t.prototype.plot=function(t){},t.prototype.draw=function(t){},t.prototype.shouldRedraw=function(){return!1},t}(),b={RED:"#f44336",PINK:"#e91e63",PURPLE:"#9c27b0",DEEP_PURPLE:"#673ab7",INDIGO:"#3f51b5",BLUE:"#2196f3",LIGHT_BLUE:"#03a9f4",CYAN:"#00bcd4",TEAL:"#009688",GREEN:"#4caf50",LIGHT_GREEN:"#8bc34a",LIME:"#cddc39",YELLOW:"#ffeb3b",AMBER:"#ffc107",ORANGE:"#ff9800",DEEP_ORANGE:"#ff5722",BROWN:"#795548",GREY:"#9e9e9e",BLUE_GREY:"#607d8b"},R=function(){function t(e){var i=e.el;l(this,t),this.el=i,this.el.style.position="relative",this.el.style.width="100%",this.el.style.height="100%",this.width=this.el.clientWidth,this.height=this.el.clientHeight,this.layers=[]}return t.spawn=function(i){var r=t.instances.indexOf(i);r!==-1&&e("Renderer has already been spawned"),t.instances.push(i)},t.kill=function(e){var i=t.instances.indexOf(e);i!==-1&&t.instances.splice(i,1)},t.digest=function(){for(var e=0;e<t.instances.length;e++){var i=t.instances[e];i.scale(),i.clear(),i.redraw()}},t.prototype.addLayer=function(t){var i=this.layers.indexOf(t);i!==-1&&e("Layer has already been added to renderer"),this.layers.push(t),this.el.appendChild(t.canvas),t.scale({width:this.width,height:this.height})},t.prototype.removeLayer=function(t){var e=this.layers.indexOf(t);e!==-1&&(this.layers.splice(e,1),this.el.removeChild(t.canvas))},t.prototype.scale=function(){var t=this.el.clientWidth,e=this.el.clientHeight;if(t!==this.width||e!==this.height){for(var i=0;i<this.layers.length;i++){var r=this.layers[i];r.scale({width:t,height:e})}this.width=t,this.height=e}},t.prototype.clear=function(){for(var t=0;t<this.layers.length;t++){var e=this.layers[t];e.shouldRedraw()&&e.clear()}},t.prototype.redraw=function(){for(var t=0;t<this.layers.length;t++){var e=this.layers[t];e.shouldRedraw()&&e.redraw()}},t}();return R.instances=[],R.BaseLayer=w,R.CanvasLayer=m,R.WebglLayer=I,R.Component=L,R.colors=b,R.utils=v,R});
