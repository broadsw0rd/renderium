!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):t.Renderium=o()}(this,function(){"use strict";function t(t,o,e){if(t+="",o-=t.length,o<=0)return t;if(e||0===e||(e=" "),e+=""," "===e&&o<10)return h[o]+t;for(var i="";;){if(1&o&&(i+=e),o>>=1,!o)break;e+=e}return i+t}function o(t){var o=t.getContext("webgl");return o||(o=t.getContext("experimental-webgl")),o}function e(t,o,e){var i=t.createShader(e);t.shaderSource(i,o),t.compileShader(i);var r=t.getShaderParameter(i,t.COMPILE_STATUS);if(!r)throw new Error("could not compile shader: "+t.getShaderInfoLog(i));return i}function i(t,o,e){var i=t.createProgram();t.attachShader(i,o),t.attachShader(i,e),t.linkProgram(i);var r=t.getProgramParameter(i,t.LINK_STATUS);if(!r)throw new Error("program failed to link: "+t.getProgramInfoLog(i));return i}function r(t){return parseInt(t.replace("#",""),16)}function n(t){t=t.match(/\d+\.?\d*/g);var o=Number(t[0]),e=Number(t[1]),i=Number(t[2]);return(o<<16)+(e<<8)+i}function a(t){var o;if(v[t])return v[t];if("#"===t[0])o=r(t);else{if("r"!==t[0])throw new Error("Wrong color format: "+t);o=n(t)}return m<_&&(v[t]=o,m++),o}var s=t,h=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],l=function(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")},c=function(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);t.prototype=Object.create(o&&o.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(t,o):t.__proto__=o)},d=function(t,o){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?t:o},p={},f={},u=function(){function t(){l(this,t)}return t.prototype.onload=function(){},t.prototype.getImage=function(t){return f[t]},t.prototype.getStatus=function(t){return p[t]},t.prototype.load=function(o){var e=this.getStatus(o),i=this;if(e!==t.IMAGE_STATUS_LOADING&&e!==t.IMAGE_STATUS_LOADED){p[o]=t.IMAGE_STATUS_LOADING;var r=new window.Image;r.onload=function(){p[o]=t.IMAGE_STATUS_LOADED,f[o]=this,i.onload()},r.src=o}},t}();u.prototype.IMAGE_STATUS_LOADING=u.IMAGE_STATUS_LOADING=1,u.prototype.IMAGE_STATUS_LOADED=u.IMAGE_STATUS_LOADED=2;var g=function(){function t(o){var e=o.Vector,i=o.stats,r=o.width,n=o.height;l(this,t),this.Vector=e||window.Vector,this.width=Number(r)||t.DEFAULT_WIDTH,this.height=Number(n)||t.DEFAULT_HEIGHT,this.logStats=Boolean(i),this.canvas=document.createElement("canvas"),this.imageLoader=new u,this.components=[],this.stats={},this._shouldRedraw=!1}return t.prototype.scale=function(o){var e=o.width,i=o.height;this.width=Number(e)||t.DEFAULT_WIDTH,this.height=Number(i)||t.DEFAULT_HEIGHT,this.canvas.removeAttribute("width"),this.canvas.removeAttribute("height"),this.canvas.removeAttribute("style"),this.canvas.width=this.width,this.canvas.height=this.height,window.devicePixelRatio&&(this.canvas.width=this.width*t.PIXEL_RATIO,this.canvas.height=this.height*t.PIXEL_RATIO),this.applyStyles(),this.forceRedraw()},t.prototype.applyStyles=function(){this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.canvas.style.position="absolute",this.canvas.style.top=0,this.canvas.style.left=0,this.canvas.style.right=0,this.canvas.style.bottom=0},t.prototype.clear=function(){this.clearStats()},t.prototype.redraw=function(){for(var t=0;t<this.components.length;t++){var o=this.components[t];o.plot(this),o.draw(this)}this._shouldRedraw=!1},t.prototype.forceRedraw=function(){this._shouldRedraw=!0},t.prototype.shouldRedraw=function(){for(var t=0;t<this.components.length;t++){var o=this.components[t];if(o.shouldRedraw())return!0}return this._shouldRedraw},t.prototype.addComponent=function(t){var o=this.components.indexOf(t);if(o!==-1)throw new Error("component "+t.constructor.name+" has already been added to layer");if("function"!=typeof t.plot||"function"!=typeof t.draw||"function"!=typeof t.shouldRedraw)throw new Error("component "+t.constructor.name+" has not implemented Component interface");this.components.push(t),this.forceRedraw()},t.prototype.addComponents=function(t){t.forEach(this.addComponent,this)},t.prototype.removeComponent=function(t){var o=this.components.indexOf(t);o!==-1&&(this.components.splice(o,1),this.forceRedraw())},t.prototype.removeComponents=function(t){t.forEach(this.removeComponent,this)},t.prototype.clearComponents=function(){this.components=[],this.forceRedraw()},t.prototype.clearStats=function(){for(var t in this.stats)this.stats[t]=0},t.prototype.collectStats=function(t){this.stats[t]++},t.prototype.formatStats=function(){var t=[],o=20;for(var e in this.stats)t.push(e+s(this.stats[e],o-e.length));return t},t}();g.PIXEL_RATIO=window.devicePixelRatio||1,g.DEFAULT_WIDTH=100,g.DEFAULT_HEIGHT=100;var w=function(){function t(o){var e=o.start,i=o.end,r=o.from,n=o.to;l(this,t),this.start=e,this.end=i,this.from=r,this.to=n,this._isGradient=!0,this._gradient=null}return t.isGradient=function(t){return t&&t._isGradient},t.prototype.createGradient=function(t){return t.collectStats("createGradient"),this._gradient=t.ctx.createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y),this._gradient.addColorStop(0,this.from),this._gradient.addColorStop(1,this.to),this._gradient},t.prototype.valueOf=function(){return this._gradient},t}(),y=function(t){function o(e){var i=e.Vector,r=e.stats,n=e.antialiasing,a=e.width,s=e.height;l(this,o);var h=d(this,t.call(this,{Vector:i,stats:r,width:a,height:s}));return h.antialiasing=Boolean(n),h.ctx=h.canvas.getContext("2d"),h.scale({width:a,height:s}),h.imageLoader.onload=h.forceRedraw.bind(h),h.stats={createGradient:0,drawArc:0,drawCircle:0,drawImage:0,drawPolygon:0,drawPolyline:0,drawRect:0,drawText:0,measureText:0,stroke:0,fill:0},h}return c(o,t),o.prototype.scale=function(o){var e=o.width,i=o.height;t.prototype.scale.call(this,{width:e,height:i}),window.devicePixelRatio&&this.ctx.scale(g.PIXEL_RATIO,g.PIXEL_RATIO),this.antialiasing||this.ctx.translate(.5,.5)},o.prototype.clear=function(){t.prototype.clear.call(this),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()},o.prototype.redraw=function(){t.prototype.redraw.call(this),this.logStats&&this.drawStats()},o.prototype.createGradient=function(t){var o=t.start,e=t.end,i=t.from,r=t.to;return new w({start:o,end:e,from:i,to:r})},o.prototype.getColor=function(t){return w.isGradient(t)?t.createGradient(this):t},o.prototype.drawArc=function(t){var o=t.position,e=t.radius,i=t.startAngle,r=t.endAngle,n=t.color,a=t.width,s=void 0===a?1:a;this.collectStats("drawArc"),this.ctx.strokeStyle=this.getColor(n),this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,e,i,r),n&&(this.collectStats("stroke"),this.ctx.stroke())},o.prototype.drawCircle=function(t){var o=t.position,e=t.radius,i=t.color,r=t.fillColor,n=t.width,a=void 0===n?1:n;this.collectStats("drawCircle"),this.drawArc({position:o,radius:e,startAngle:0,endAngle:2*Math.PI,color:i,width:a}),r&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(r),this.ctx.fill())},o.prototype.drawImage=function(t){var o=t.position,e=t.image,i=t.width,r=void 0===i?e.width:i,n=t.height,a=void 0===n?e.height:n,s=t.opacity,h=void 0===s?1:s;if(this.collectStats("drawImage"),"string"==typeof e){if(this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(e)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(e):void 0;e=this.imageLoader.getImage(e),r=r||e.width,a=a||e.height}var l=this.ctx.globalAlpha;this.ctx.globalAlpha=h,this.antialiasing?this.ctx.drawImage(e,o.x,o.y,r,a):this.ctx.drawImage(e,o.x-.5,o.y-.5,r,a),this.ctx.globalAlpha=l},o.prototype.drawPolygon=function(t){var o=t.points,e=t.color,i=t.fillColor,r=t.width,n=void 0===r?1:r;this.collectStats("drawPolygon"),this.drawPolyline({points:o.concat(o[0]),color:e,width:n}),i&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(i),this.ctx.fill())},o.prototype.drawPolyline=function(t){var o=t.points,e=t.color,i=t.lineDash,r=void 0===i?[]:i,n=t.width,a=void 0===n?1:n;this.collectStats("drawPolyline"),this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(o[0].x,o[0].y);for(var s,h=1;h<o.length;h++)s=o[h],this.ctx.lineTo(s.x,s.y);this.ctx.setLineDash(r),o[0].equals(o[o.length-1])&&this.ctx.closePath(),e&&(this.collectStats("stroke"),this.ctx.strokeStyle=this.getColor(e),this.ctx.stroke())},o.prototype.drawRect=function(t){var o=t.position,e=t.width,i=t.height,r=t.color,n=t.fillColor,a=t.strokeWidth,s=void 0===a?1:a;this.collectStats("drawRect"),this.ctx.lineWidth=s,this.ctx.beginPath(),this.antialiasing?this.ctx.rect(o.x,o.y,e,i):this.ctx.rect(o.x-.5,o.y-.5,e,i),this.ctx.closePath(),r&&(this.collectStats("stroke"),this.ctx.strokeStyle=this.getColor(r),this.ctx.stroke()),n&&(this.collectStats("fill"),this.ctx.fillStyle=this.getColor(n),this.ctx.fill())},o.prototype.drawText=function(t){var o=t.position,e=t.text,i=t.color,r=t.font,n=t.size,a=t.align,s=void 0===a?"center":a,h=t.baseline,l=void 0===h?"middle":h;this.collectStats("drawText"),this.ctx.fillStyle=this.getColor(i),this.ctx.font=n+"px "+r,this.ctx.textAlign=s,this.ctx.textBaseline=l,this.ctx.fillText(e,o.x,o.y)},o.prototype.measureText=function(t){var o=t.text,e=t.font,i=t.size;this.collectStats("measureText");var r;if(e&&i){var n=this.ctx.font;this.ctx.font=i+"px "+e,r=this.ctx.measureText(o).width,this.ctx.font=n}else r=this.ctx.measureText(o).width;return r},o.prototype.drawStats=function(){for(var t=this.formatStats(),o=t.length;o--;)this.drawText({position:new this.Vector(this.width-10,this.height-14*(t.length-o)),text:t[o],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},o}(g),v={},m=0,_=64,x=function(){function t(o){var e=o.start,i=o.end,r=o.from,n=o.to;l(this,t),this.start=e,this.end=i,this.from=a(r),this.to=a(n),this._isGradient=!0,this._gradient=null}return t.isGradient=function(t){return t&&t._isGradient},t.prototype.createGradient=function(t){return t.collectStats("createGradient"),this.from},t.prototype.valueOf=function(){return this.from},t}(),A="uniform vec2 u_resolution;\r\nuniform float u_ratio;\r\n\r\nattribute vec2 a_position;\r\nattribute float a_color;\r\n\r\nvarying vec4 v_color;\r\n\r\nvoid main() {\r\n  // convert points\r\n  vec2 position = (a_position / u_resolution * 2.0 - 1.0) * vec2(1, -1) * u_ratio;\r\n  gl_Position = vec4(position, 0, 1);\r\n\r\n  // because bitwise operators not supported\r\n  float color = a_color;\r\n  v_color.b = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  v_color.g = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  v_color.r = mod(color, 256.0) / 255.0; color = floor(color / 256.0);\r\n  v_color.a = 1.0;\r\n}\r\n",E="precision mediump float;\r\nvarying vec4 v_color;\r\nvoid main() {\r\n  gl_FragColor = v_color;\r\n}\r\n",S=function(t){function r(n){var a=n.Vector,s=n.stats,h=n.width,c=n.height;l(this,r);var p=d(this,t.call(this,{Vector:a,stats:s,width:h,height:c}));return p.gl=o(p.canvas),p.scale({width:h,height:c}),p.imageLoader.onload=p.forceRedraw.bind(p),p.positions=[],p._vertexShader=e(p.gl,A,p.gl.VERTEX_SHADER),p._fragmentShader=e(p.gl,E,p.gl.FRAGMENT_SHADER),p._program=i(p.gl,p._vertexShader,p._fragmentShader),p.gl.useProgram(p._program),p._resolutionLocation=p.gl.getUniformLocation(p._program,"u_resolution"),p._ratioLocation=p.gl.getUniformLocation(p._program,"u_ratio"),p._positionLocation=p.gl.getAttribLocation(p._program,"a_position"),p._colorLocation=p.gl.getAttribLocation(p._program,"a_color"),p._buffer=p.gl.createBuffer(),p.gl.bindBuffer(p.gl.ARRAY_BUFFER,p._buffer),p.gl.enableVertexAttribArray(p._positionLocation),p.gl.enableVertexAttribArray(p._colorLocation),p.attributesLength=3,p.gl.vertexAttribPointer(p._positionLocation,2,p.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*p.attributesLength,0),p.gl.vertexAttribPointer(p._colorLocation,1,p.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*p.attributesLength,2*Float32Array.BYTES_PER_ELEMENT),p}return c(r,t),r.prototype.scale=function(o){var e=o.width,i=o.height;t.prototype.scale.call(this,{width:e,height:i}),this.gl.viewport(0,0,this.width*g.PIXEL_RATIO,this.height*g.PIXEL_RATIO)},r.prototype.clear=function(){t.prototype.clear.call(this),this.positions=[],this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},r.prototype.redraw=function(){t.prototype.redraw.call(this),this.gl.uniform2f(this._resolutionLocation,this.width,this.height),this.gl.uniform1f(this._ratioLocation,g.PIXEL_RATIO),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.positions),this.gl.STATIC_DRAW),this.gl.drawArrays(this.gl.LINES,0,this.positions.length/this.attributesLength)},r.prototype.createGradient=function(t){var o=t.start,e=t.end,i=t.from,r=t.to;return new x({start:o,end:e,from:i,to:r})},r.prototype.getColor=function(t){return x.isGradient(t)?t.createGradient(this):a(t)},r.prototype.drawArc=function(t){t.position,t.radius,t.startAngle,t.endAngle,t.color,t.width},r.prototype.drawCircle=function(t){t.position,t.radius,t.color,t.fillColor,t.width},r.prototype.drawImage=function(t){var o=(t.position,t.image),e=t.width,i=void 0===e?o.width:e,r=t.height,n=void 0===r?o.height:r;t.opacity;if("string"==typeof o){if(this.imageLoader.getStatus(o)!==this.imageLoader.IMAGE_STATUS_LOADED)return this.imageLoader.getStatus(o)!==this.imageLoader.IMAGE_STATUS_LOADING?void this.imageLoader.load(o):void 0;o=this.imageLoader.getImage(o),i=i||o.width,n=n||o.height}},r.prototype.drawPolygon=function(t){var o=t.points,e=t.color,i=(t.fillColor,t.width),r=void 0===i?1:i;this.collectStats("drawPolygon"),this.drawPolyline({points:o.concat(o[0]),color:e,width:r})},r.prototype.drawPolyline=function(t){var o=t.points,e=t.color;t.lineDash,t.width;this.collectStats("drawPolyline"),e=this.getColor(e);for(var i=1;i<o.length;i++)this.positions.push(o[i-1].x,o[i-1].y,e),this.positions.push(o[i].x,o[i].y,e)},r.prototype.drawRect=function(t){t.position,t.width,t.height,t.color,t.fillColor,t.strokeWidth},r.prototype.drawText=function(t){t.position,t.text,t.color,t.font,t.size,t.align,t.baseline},r.prototype.measureText=function(t){t.text;return 0},r.prototype.drawStats=function(){for(var t=this.formatStats(),o=t.length;o--;)this.drawText({position:new this.Vector(this.width-10,this.height-14*(t.length-o)),text:t[o],color:"#fff",font:"Courier, monospace",size:14,align:"right",baleline:"bottom"})},r}(g),L=function(){function t(){l(this,t)}return t.prototype.plot=function(t){},t.prototype.draw=function(t){},t.prototype.shouldRedraw=function(){return!1},t}(),T={RED:"#f44336",PINK:"#e91e63",PURPLE:"#9c27b0",DEEP_PURPLE:"#673ab7",INDIGO:"#3f51b5",BLUE:"#2196f3",LIGHT_BLUE:"#03a9f4",CYAN:"#00bcd4",TEAL:"#009688",GREEN:"#4caf50",LIGHT_GREEN:"#8bc34a",LIME:"#cddc39",YELLOW:"#ffeb3b",AMBER:"#ffc107",ORANGE:"#ff9800",DEEP_ORANGE:"#ff5722",BROWN:"#795548",GREY:"#9e9e9e",BLUE_GREY:"#607d8b"},b=function(){function t(o){var e=o.el;l(this,t),this.el=e,this.el.style.position="relative",this.el.style.width="100%",this.el.style.height="100%",this.width=this.el.clientWidth,this.height=this.el.clientHeight,this.layers=[]}return t.spawn=function(o){var e=t.instances.indexOf(o);if(e!==-1)throw new Error("renderer has already been spawned");t.instances.push(o)},t.kill=function(o){var e=t.instances.indexOf(o);e!==-1&&t.instances.splice(e,1)},t.digest=function(){for(var o=0;o<t.instances.length;o++){var e=t.instances[o];e.scale(),e.clear(),e.redraw()}},t.prototype.addLayer=function(t){var o=this.layers.indexOf(t);if(o!==-1)throw new Error("layer has already been added to renderer");this.layers.push(t),this.el.appendChild(t.canvas),t.scale({width:this.width,height:this.height})},t.prototype.removeLayer=function(t){var o=this.layers.indexOf(t);o!==-1&&(this.layers.splice(o,1),this.el.removeChild(t.canvas))},t.prototype.scale=function(){var t=this.el.clientWidth,o=this.el.clientHeight;if(t!==this.width||o!==this.height){for(var e=0;e<this.layers.length;e++){var i=this.layers[e];i.scale({width:t,height:o})}this.width=t,this.height=o}},t.prototype.clear=function(){for(var t=0;t<this.layers.length;t++){var o=this.layers[t];o.shouldRedraw()&&o.clear()}},t.prototype.redraw=function(){for(var t=0;t<this.layers.length;t++){var o=this.layers[t];o.shouldRedraw()&&o.redraw()}},t}();return b.instances=[],b.BaseLayer=g,b.CanvasLayer=y,b.WebglLayer=S,b.Component=L,b.colors=T,b});
